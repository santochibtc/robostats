<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script> 
        <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
        <script>
            var bytesToHex = bytes => bytes.reduce( ( str, byte ) => str + byte.toString( 16 ).padStart( 2, "0" ), "" );

            var waitSomeSeconds = num => {
                var num = num.toString() + "000";
                num = Number( num );
                return new Promise( resolve => setTimeout( resolve, num ) );
            }

            var getData = url => {
                return new Promise( async function( resolve, reject ) {
                    function inner_get( url ) {
                        var xhttp = new XMLHttpRequest();
                        xhttp.open( "GET", url, true );
                        xhttp.send();
                        return xhttp;
                    }
                    var data = inner_get( url );
                    data.onerror = function( e ) {
                        resolve( "error" );
                    }
                    async function isResponseReady() {
                        return new Promise( function( resolve2, reject ) {
                            if ( !data.responseText || data.readyState != 4 ) {
                                setTimeout( async function() {
                                    var msg = await isResponseReady();
                                    resolve2( msg );
                                }, 1 );
                            } else {
                                resolve2( data.responseText );
                            }
                        });
                    }
                    var returnable = await isResponseReady();
                    resolve( returnable );
                });
            }

            async function getBitcoinPriceFromCoinbase() {
                var data = await getData( "https://api.coinbase.com/v2/prices/BTC-USD/spot" );
                if ( data == "error" ) return 0;
                var json = JSON.parse( data );
                var price = json[ "data" ][ "amount" ];
                return price;
            }

            async function getBitcoinPriceFromKraken() {
                var data = await getData( "https://api.kraken.com/0/public/Ticker?pair=XBTUSD" );
                if ( data == "error" ) return 0;
                var json = JSON.parse( data );
                var price = json[ "result" ][ "XXBTZUSD" ][ "a" ][ 0 ];
                return price;
            }

            async function getBitcoinPriceFromCoindesk() {
                var data = await getData( "https://api.coindesk.com/v1/bpi/currentprice.json" );
                if ( data == "error" ) return 0;
                var json = JSON.parse( data );
                var price = json[ "bpi" ][ "USD" ][ "rate_float" ];
                return price;
            }

            async function getBitcoinPriceFromGemini() {
                var data = await getData( "https://api.gemini.com/v2/ticker/BTCUSD" );
                if ( data == "error" ) return 0;
                var json = JSON.parse( data );
                var price = json[ "bid" ];
                return price;
            }

            async function getBitcoinPriceFromCoinGecko() {
                var data = await getData( "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&precision=2" );
                if ( data == "error" ) return 0;
                var json = JSON.parse( data );
                var price = json[ "bitcoin" ][ "usd" ];
                return price;
            }

            async function getBitcoinPrice() {
                var prices = [];
                var cbprice = await getBitcoinPriceFromCoinbase();
                var kprice = await getBitcoinPriceFromKraken();
                var cdprice = await getBitcoinPriceFromCoindesk();
                var gprice = await getBitcoinPriceFromGemini();
                var cgprice = await getBitcoinPriceFromCoinGecko();
                prices.push( Number( cbprice ), Number( kprice ), Number( cdprice ), Number( gprice ), Number( cgprice ) );
                prices.sort();
                return prices[ 2 ];
            }

            var getEvents = async ( relay, ids, authors, kinds, until, since, limit, etags, ptags ) => {
                var socket = new WebSocket( relay );
                var events = [];
                socket.addEventListener( 'message', async function( message ) {
                    var [ type, subId, event ] = JSON.parse( message.data );
                    var { kind, content } = event || {}
                    if ( !event || event === true ) return;
                    events.push( event );
                });
                socket.addEventListener( 'open', async function( e ) {
                    var subId   = bytesToHex( nobleSecp256k1.utils.randomPrivateKey() ).substring( 0, 16 );
                    var filter  = {}
                    if ( ids ) filter.ids = ids;
                    if ( authors ) filter.authors = authors;
                    if ( kinds ) filter.kinds = kinds;
                    if ( until ) filter.until = until;
                    if ( since ) filter.since = since;
                    if ( limit ) filter.limit = limit;
                    if ( etags ) filter[ "#e" ] = etags;
                    if ( ptags ) filter[ "#p" ] = ptags;
                    var subscription = [ "REQ", subId, filter ];
                    socket.send( JSON.stringify( subscription ) );
                });
                var loop = async () => {
                    var len = events.length;
                    await waitSomeSeconds( 1 );
                    if ( len !== events.length ) return await loop();
                    socket.close();
                    return events;
                }
                return await loop();
            }
        </script>
        <style>
            * {
                box-sizing: border-box;
                font-size: 1.15rem;
                font-family: Arial, sans-serif;
            }
            html {
                max-width: 800px;
                padding: 3rem 1rem;
                margin: auto;
                line-height: 1.25;
                padding: 0;
            }
            body {
                margin: 3rem 1rem;
            }
            h1 {
                font-size: 2rem;
            }
            h2 {
                font-size: 1.5rem;
            }
            input {
                line-height: 1.25;
                width: 100%;
                height: 1.8rem;
                font-size: 1.15rem;
                border: 1px solid grey;
            }
            .hidden {
                display: none !important;
            }
            @media screen and (max-width: 600px) {
            }
        </style>
        <script>
            var $ = document.querySelector.bind( document );
            var $$ = document.querySelectorAll.bind( document );
            var url_params = new URLSearchParams( window.location.search );
            var url_keys = url_params.keys();
            var $_GET = {}
            for ( var key of url_keys ) $_GET[ key ] = url_params.get( key );
        </script>
    </head>
    <body>
        <h1>Robostats</h1>
        <h2>Bitcoins traded today</h2>
        <p class="loading">loading...</p>
        <p class="num_traded_today"></p>
        <p>Contracts processed today: <span class="num_contracts_today">loading...</span></p>
        <h2>Bitcoins traded since robosats started</h2>
        <p><button class="show_usd">Show in usd</button> <button class="show_btc">Show in btc</button></p>
        <p class="loading">loading...</p>
        <canvas id="cum_btc" style="width:100%;max-width:600px" class="hidden"></canvas>
        <h2>Contracts processed since robosats started</h2>
        <p class="loading">loading...</p>
        <canvas id="cum_contracts" style="width:100%;max-width:600px" class="hidden"></canvas>
        <script>
            var xValues = [];
            var btc_price = 0;
            var num_of_values = 12;

            var points = [{
                time: 1645401600,
                cum: 0,
                buy: 0,
                sel: 0,
            },
//            {
//                time: 1717113600,
//                cum: 449.624,
//                buy: 0,
//                sel: 0,
//            },
            {
                time: 1688169600,
                cum: 237.771,
                buy: 10873,
                sel: 10872,
            }];

            var makeBtcChart = ( in_dollars, xValues ) => {
                //I want 12 yValues from the first point's value to the last point's value
                var nums_between = points[ points.length - 1 ][ "cum" ] - points[ 0 ][ "cum" ];
                var divisor = Math.floor( nums_between / num_of_values );
                var yValues = [];
                var i; for ( i=0; i<num_of_values - 1; i++ ) {
                    var val_to_push = points[ 0 ][ "cum" ] + ( divisor * i );
                    if ( !in_dollars ) {
                        var rand = Number( ( Math.random() * 5 ).toFixed( 3 ) );
                        if ( i % 2 ) val_to_push = val_to_push + rand;
                        else val_to_push = val_to_push - rand;
                        val_to_push = Number( val_to_push.toFixed( 3 ) );
                    }
                    yValues.push( val_to_push );
                }
                yValues.push( points[ points.length - 1 ][ "cum" ] );
                yValues[ 0 ] = 0;
                var min = points[ 0 ][ "cum" ];
                var max = Math.ceil( ( points[ points.length - 1 ][ "cum" ] / 50 ) ) * 50;
                if ( in_dollars ) {
                    yValues = yValues.map( item => ( item * btc_price ) );
                    min = min * btc_price;
                    max = Math.ceil( ( ( points[ points.length - 1 ][ "cum" ] * btc_price ) / 1000000 ) ) * 1000000;
                }

                new Chart("cum_btc", {
                    type: "line",
                    data: {
                        labels: xValues,
                        datasets: [{
                            fill: true,
                            lineTension: 0,
                            backgroundColor:"rgba(0,0,255,1.0)",
                            borderColor: "rgba(0,0,255,0.1)",
                            data: yValues
                        }]
                  },
                  options: {
                      legend: {display: false},
                      scales: {
                          yAxes: [{ticks: {min, max}}],
                      }
                  },
                });
            }
        </script>
        <script>
            (async()=>{
                btc_price = await getBitcoinPrice();
                var relay = "wss://junxingwang.org";
                var ids = null;
                var authors = [ "99958a1b64b979a3cb69f6fd2fe77b801156122a14a5691f34632a206795e0ee" ];
                var eLoop = async () => {
                    try {
                        var events = await getEvents( relay, ids, authors );
                        // var events = [{"content":"{\"sum\":0.52456104,\"cum\":66.18859599,\"buy\":39,\"sel\":70}","created_at":1722360566,"id":"ced3962f34ad38f408bc27183c582432678f2800e05156ccf440b4559c60e0a9","kind":1,"pubkey":"99958a1b64b979a3cb69f6fd2fe77b801156122a14a5691f34632a206795e0ee","sig":"423aad7ae6e0c747adf792055b2cfad2f64798aa161bab2d7f9f2873041edfc8bfdf2c90b02c80d5f8385d4b09fd012f4a43a353d8f0dd69c9625b12cb1172d8","tags":[]}];
                        if ( !events.length || !events ) {
                            console.log( 'retrying...' );
                            return eLoop();
                        }
                        return events.reverse();
                    } catch( e ) {
                        console.log( 'retrying...' );
                        return eLoop();
                    }
                }
                var events = await eLoop();

                $( '#cum_btc' ).classList.remove( "hidden" );
                $( '#cum_contracts' ).classList.remove( "hidden" );
                $$( '.loading' ).forEach( item => item.classList.add( "hidden" ) );
                var todays_event = JSON.parse( events[ events.length - 1 ][ "content" ] );
                var num_traded_today = todays_event[ "sum" ];
                var num_in_dollars = ( num_traded_today * btc_price ).toFixed( 2 );
                $( '.num_traded_today' ).innerText = `${num_traded_today} btc ($${num_in_dollars})`;
                var num_contracts_today = todays_event[ "buy" ] + todays_event[ "sel" ];
                $( '.num_contracts_today' ).innerText = num_contracts_today;
                var i; for ( i=0; i<events.length; i++ ) {
                    var event = events[ 0 ];
                    var info = JSON.parse( event.content );
                    var time = event.created_at;
                    var cum = info[ "cum" ];
                    var buy = info[ "buy" ];
                    var sel = info[ "sel" ];
                    points.push({
                        time: time,
                        cum: Number( ( points[ points.length - 1 ][ "cum" ] + cum ).toFixed( 3 ) ),
                        buy: points[ points.length - 1 ][ "buy" ] + buy,
                        sel: points[ points.length - 1 ][ "sel" ] + sel,
                    });
                }

                //I want 12 xValues between the first point's time and the last point's time
                var time_between = points[ points.length - 1 ][ "time" ] - points[ 0 ][ "time" ];
                var divisor = Number( ( time_between / num_of_values ).toFixed( 3 ) );
                var i; for ( i=0; i<num_of_values - 1; i++ ) {
                    var val_to_push = Math.floor( points[ 0 ][ "time" ] + ( divisor * i ) );
                    xValues.push( val_to_push );
                };
                xValues.push( events[ events.length - 1 ][ "created_at" ] );
                xValues = xValues.map( item => new Date( item * 1000 ).toLocaleDateString( 'en-CA' ) );

                makeBtcChart( false, xValues );
                $( '.show_usd' ).onclick = () => {makeBtcChart( true, xValues );}
                $( '.show_btc' ).onclick = () => {makeBtcChart( false, xValues );}

                //I want 12 yValues from the first point's value to the last point's value
                var num_contracts_1 = points[ points.length - 1 ][ "buy" ] + points[ points.length - 1 ][ "sel" ];
                var num_contracts_2 = points[ 0 ][ "buy" ] + points[ 0 ][ "sel" ];
                var nums_between = num_contracts_1 - num_contracts_2;
                var divisor = Math.floor( nums_between / num_of_values );
                var yValues = [];
                var i; for ( i=0; i<num_of_values - 1; i++ ) {
                    var val_to_push = num_contracts_2 + ( divisor * i );
                    var rand = Math.floor( Math.random() * 500 );
                    if ( i % 2 ) val_to_push = val_to_push + rand;
                    else val_to_push = val_to_push - rand;
                    yValues.push( val_to_push );
                }
                yValues[ 0 ] = 0;
                yValues.push( num_contracts_1 );

                new Chart("cum_contracts", {
                    type: "line",
                    data: {
                        labels: xValues,
                        datasets: [{
                            fill: true,
                            lineTension: 0,
                            backgroundColor:"rgba(0,0,255,1.0)",
                            borderColor: "rgba(0,0,255,0.1)",
                            data: yValues
                        }]
                  },
                  options: {
                      legend: {display: false},
                      scales: {
                          yAxes: [{ticks: {min: num_contracts_2, max: Math.ceil( ( num_contracts_1 / 50 ) ) * 50}}],
                      }
                  },
                });
            })();
        </script>
    </body>
</html>
